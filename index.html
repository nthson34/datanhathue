<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Dá»® LIá»†U NHÃ€ THUÃŠ</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
body{font-family:Inter,sans-serif;background:#f1f5f9;overscroll-behavior:none}
.card{border-radius:18px}
.badge{font-size:12px;padding:4px 10px;border-radius:999px}
.thumb{height:110px;border-radius:14px;background-size:cover;background-position:center;cursor:pointer}
#imgModal{touch-action:none}
#modalImg{max-width:95vw;max-height:90vh;transform-origin:center;transition:transform .12s ease;user-select:none}
</style>
</head>

<body>

<header class="bg-gradient-to-r from-indigo-700 to-blue-700 text-white sticky top-0 z-20 shadow">
  <div class="max-w-3xl mx-auto px-4 py-4 space-y-3">
    <h1 class="text-2xl font-extrabold text-center">Dá»® LIá»†U NHÃ€ THUÃŠ</h1>
    <div class="flex gap-2">
      <input id="search" type="text" placeholder="ğŸ” Äá»‹a chá»‰ | SÄT | GiÃ¡ | Hoa há»“ng" class="flex-1 p-3 rounded-xl text-gray-800" disabled>
      <button id="btn" class="bg-white/20 px-4 rounded-xl font-semibold text-sm" disabled>TÃ¬m</button>
    </div>
  </div>
</header>

<main class="max-w-3xl mx-auto p-3 space-y-4">
  <div id="loading" class="bg-white p-6 rounded-xl shadow text-center">
    <div class="w-8 h-8 border-4 border-gray-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-3"></div>
    <p class="text-sm">Äang táº£i dá»¯ liá»‡u...</p>
  </div>
  <div id="list" class="space-y-4 hidden"></div>
  <div id="empty" class="hidden bg-yellow-50 border-l-4 border-yellow-500 p-4 text-sm">
    KhÃ´ng tÃ¬m tháº¥y tÃ i sáº£n phÃ¹ há»£p
  </div>
</main>

<div id="imgModal" class="fixed inset-0 bg-black/90 hidden z-50 flex items-center justify-center">
  <div id="imgCount" class="absolute top-4 left-4 text-white text-sm"></div>
  <button onclick="closeModal()" class="absolute top-4 right-4 text-white text-3xl">âœ•</button>
  <img id="modalImg">
</div>

<script>
const SHEET_ID='14ntbPzHZdUEBAx7FxwEfpO0wBjyqaxNzXVYYphe_q2A';
const GID='61368668';
const URL=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID}&tqx=out:json&tq=${encodeURIComponent('select A,B,C,D,E,F,G,H,I,J')}`;
const $=id=>document.getElementById(id);
let DATA=[], DISPLAY_DATA=[];

/* CLEAN JSON */
const cleanJSON=t=>JSON.parse(t.replace('/*O_o*/','').replace('google.visualization.Query.setResponse(','').slice(0,-2));
function driveToImage(url){if(!url)return'';let m=url.match(/\/d\/([a-zA-Z0-9_-]+)/)||url.match(/id=([a-zA-Z0-9_-]+)/);return m?`https://lh3.googleusercontent.com/d/${m[1]}=w800`:''}

/* LOAD DATA */
async function loadData(){
  const res=await fetch(URL);
  const txt=await res.text();
  const json=cleanJSON(txt);
  DATA=json.table.rows.map(r=>{
    const images=[driveToImage(r.c?.[7]?.v),driveToImage(r.c?.[8]?.v),driveToImage(r.c?.[9]?.v)].filter(Boolean);
    return{
      owner:r.c?.[0]?.v||'',
      phone:r.c?.[1]?.v||'',
      address:r.c?.[2]?.v||'',
      price:r.c?.[3]?.v||'',
      deposit:r.c?.[4]?.v||'',
      commission:r.c?.[5]?.v||'',
      imageLink:r.c?.[6]?.v||'',
      images
    };
  }).filter(i=>i.address);
  DISPLAY_DATA = [...DATA];
  $('loading').classList.add('hidden');
  $('search').disabled=false;
  $('btn').disabled=false;
  render(DISPLAY_DATA);
}

/* SEARCH */
function search(){
  const k=$('search').value.toLowerCase().trim();
  $('search').blur(); // áº©n bÃ n phÃ­m
  DISPLAY_DATA = !k ? [...DATA] : DATA.filter(i=>[i.address,i.phone,i.price,i.deposit,i.commission].join(' ').toLowerCase().includes(k));
  render(DISPLAY_DATA);
}

/* COPY PHONE */
function copyPhone(btn,phone){navigator.clipboard.writeText(phone).then(()=>{const old=btn.innerHTML;btn.innerHTML='âœ“';setTimeout(()=>btn.innerHTML=old,1000);});}

/* RENDER */
function render(arr){
  const box=$('list'); box.innerHTML=''; $('empty').classList.add('hidden');
  if(!arr.length){box.classList.add('hidden');$('empty').classList.remove('hidden');return;}
  box.classList.remove('hidden');
  box.innerHTML=arr.map((i,ci)=>`
    <div class="card bg-white p-4 shadow space-y-3">
      ${i.images.length?`<div class="grid grid-cols-3 gap-2">
        ${i.images.map((img,idx)=>`
          <div class="thumb" data-idx="${idx}" data-card="${ci}" style="background-image:url('${img}')"></div>
        `).join('')}
      </div>`:''}
      <div class="bg-indigo-50 border border-indigo-200 rounded-xl p-3">
        <div class="text-xs uppercase text-indigo-500">Äá»‹a chá»‰</div>
        <div class="font-bold text-indigo-800">ğŸ“ ${i.address}</div>
      </div>
      <div class="bg-red-50 border border-red-200 text-red-700 font-extrabold px-3 py-2 rounded-xl text-sm">
        ğŸ’° GiÃ¡ thuÃª: ${i.price}
      </div>
      <div class="flex gap-2">
        <span class="badge bg-gray-100">Cá»c ${i.deposit}</span>
        <span class="badge bg-green-100 text-green-700 font-semibold">HH ${i.commission}</span>
      </div>
      <div class="flex gap-2">
        <a href="tel:${i.phone}" class="flex-1 bg-green-600 text-white py-2 rounded-xl text-center font-semibold">
          ğŸ“ Gá»ŒI NGAY (${i.phone})
        </a>
        <button onclick="copyPhone(this,'${i.phone}')" class="bg-gray-200 px-3 rounded-xl">ğŸ“‹</button>
      </div>
      <div class="text-sm text-gray-500">ğŸ‘¤ ${i.owner}</div>
    </div>
  `).join('');
}

/* ================= POPUP ================= */
let modalImgs=[], modalIdx=0, scale=1, dx=0, dy=0, startX=0, startY=0, startDist=0;
const imgModal=$('imgModal'), modalImg=$('modalImg'), imgCount=$('imgCount');

document.addEventListener('click',e=>{
  const t=e.target.closest('.thumb'); if(!t)return;
  const cardIdx = +t.dataset.card;
  modalImgs = DISPLAY_DATA[cardIdx].images; // <-- dÃ¹ng DISPLAY_DATA sau filter
  modalIdx = +t.dataset.idx;
  dx=0; dy=0; scale=1; apply();
  openModal();
});

function openModal(){modalImg.src=modalImgs[modalIdx]; imgCount.innerText=`${modalIdx+1}/${modalImgs.length}`; imgModal.classList.remove('hidden');}
function closeModal(){imgModal.classList.add('hidden');}
function apply(){modalImg.style.transform=`translate(${dx}px,${dy}px) scale(${scale})`;}

/* TOUCH */
imgModal.addEventListener('touchstart',e=>{
  if(e.touches.length===2) startDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
  else {startX=e.touches[0].clientX; startY=e.touches[0].clientY;}
},{passive:false});

imgModal.addEventListener('touchmove',e=>{
  e.preventDefault();
  if(e.touches.length===2){
    let d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
    scale=Math.min(Math.max(1,scale*d/startDist),3); startDist=d;
  } else if(scale>1){dx+=e.touches[0].clientX-startX; dy+=e.touches[0].clientY-startY; startX=e.touches[0].clientX; startY=e.touches[0].clientY;}
  apply();
},{passive:false});

imgModal.addEventListener('touchend',()=>{
  if(scale===1 && Math.abs(dx)>50){
    modalIdx=dx<0?(modalIdx+1)%modalImgs.length:(modalIdx-1+modalImgs.length)%modalImgs.length;
    dx=0; dy=0; scale=1; apply();
    openModal();
  }
  dx=0; dy=0;
});

/* EVENTS */
$('btn').onclick=search;
$('search').addEventListener('keydown',e=>{if(e.key==='Enter') search();});

/* LOAD */
loadData();
</script>
</body>
</html>
