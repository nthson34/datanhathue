<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>D·ªÆ LI·ªÜU NH√Ä THU√ä</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
body { font-family: Inter, sans-serif; background:#f1f5f9; }
.card { border-radius:18px; }
.badge { font-size:12px; padding:4px 10px; border-radius:999px; }

.line-2{
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

/* ===== MODAL IMAGE ===== */
#imgModal {
  touch-action: none;
}
#modalImg {
  transition: transform .15s ease;
  transform-origin: center center;
}
</style>
</head>

<body>

<header class="bg-gradient-to-r from-indigo-700 to-blue-700 text-white sticky top-0 z-10 shadow">
  <div class="max-w-3xl mx-auto px-4 py-4 space-y-3">
    <h1 class="text-2xl font-extrabold text-center">D·ªÆ LI·ªÜU NH√Ä THU√ä</h1>
  </div>
</header>

<main class="max-w-3xl mx-auto p-3 space-y-4">
  <div id="list"></div>
</main>

<!-- ================= IMAGE MODAL ================= -->
<div id="imgModal"
  class="fixed inset-0 bg-black/90 hidden z-50 flex items-center justify-center">

  <div class="absolute top-4 left-4 text-white text-sm" id="imgCount"></div>

  <button onclick="closeModal()"
    class="absolute top-4 right-4 text-white text-3xl font-bold">‚úï</button>

  <img id="modalImg"
    class="max-w-[95%] max-h-[90%] rounded-xl select-none">

</div>

<script>
/* ================= CONFIG ================= */
const SHEET_ID = '14ntbPzHZdUEBAx7FxwEfpO0wBjyqaxNzXVYYphe_q2A';
const GID = '61368668';

const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID}&tqx=out:json&tq=${
  encodeURIComponent('select A,B,C,D,E,F,G,H,I,J')
}`;

const $ = id => document.getElementById(id);
let DATA = [];

/* ================= CLEAN JSON ================= */
function cleanJSON(text){
  return JSON.parse(
    text.replace('/*O_o*/','')
        .replace('google.visualization.Query.setResponse(','')
        .slice(0,-2)
  );
}

/* ================= DRIVE ‚Üí IMAGE ================= */
function driveToImage(url){
  if(!url) return '';
  let m = url.match(/\/d\/([a-zA-Z0-9_-]+)/) || url.match(/id=([a-zA-Z0-9_-]+)/);
  if(!m) return '';
  return `https://lh3.googleusercontent.com/d/${m[1]}=w1600`;
}

/* ================= LOAD ================= */
fetch(URL)
  .then(r=>r.text())
  .then(t=>{
    const j = cleanJSON(t);
    DATA = j.table.rows.map(r=>{
      const images = [
        driveToImage(r.c?.[7]?.v),
        driveToImage(r.c?.[8]?.v),
        driveToImage(r.c?.[9]?.v)
      ].filter(Boolean);
      return {
        address:r.c?.[2]?.v||'',
        price:r.c?.[3]?.v||'',
        phone:r.c?.[1]?.v||'',
        images
      };
    }).filter(i=>i.address);
    render();
  });

/* ================= RENDER ================= */
function render(){
  $('list').innerHTML = DATA.map(i=>`
    <div class="card bg-white p-4 shadow space-y-3 mb-4">
      ${i.images.length?`
      <div class="grid grid-cols-3 gap-2">
        ${i.images.map((img,idx)=>`
          <img src="${img}"
            onclick='openModal(${JSON.stringify(i.images)},${idx})'
            class="w-full h-32 object-cover rounded-xl cursor-pointer">
        `).join('')}
      </div>`:''}

      <div class="font-bold">üìç ${i.address}</div>
      <div class="text-red-600 font-extrabold">üí∞ ${i.price}</div>
      <a href="tel:${i.phone}"
        class="block bg-green-600 text-white py-2 rounded-xl text-center font-semibold">
        üìû ${i.phone}
      </a>
    </div>
  `).join('');
}

/* ================= MODAL LOGIC ================= */
let modalImages=[], idx=0;
let scale=1, startX=0, startY=0, dx=0, dy=0;
let startDist=0;

function openModal(images,i){
  modalImages = images;
  idx = i;
  resetTransform();
  updateImg();
  $('imgModal').classList.remove('hidden');
}

function closeModal(){
  $('imgModal').classList.add('hidden');
}

function updateImg(){
  $('modalImg').src = modalImages[idx];
  $('imgCount').innerText = `${idx+1}/${modalImages.length}`;
}

function resetTransform(){
  scale=1; dx=0; dy=0;
  applyTransform();
}

function applyTransform(){
  $('modalImg').style.transform =
    `translate(${dx}px,${dy}px) scale(${scale})`;
}

/* ===== TOUCH EVENTS ===== */
let touches=[];

$('imgModal').addEventListener('touchstart',e=>{
  touches = [...e.touches];
  if(touches.length===2){
    startDist = getDist(touches);
  }else{
    startX = touches[0].clientX;
    startY = touches[0].clientY;
  }
},{passive:false});

$('imgModal').addEventListener('touchmove',e=>{
  e.preventDefault();
  if(e.touches.length===2){
    const dist = getDist(e.touches);
    scale = Math.min(Math.max(1, scale * dist/startDist),3);
    startDist = dist;
  }else{
    const x = e.touches[0].clientX;
    const y = e.touches[0].clientY;
    dx += x-startX;
    dy += y-startY;
    startX=x; startY=y;
  }
  applyTransform();
},{passive:false});

$('imgModal').addEventListener('touchend',e=>{
  if(scale===1 && Math.abs(dx)>80){
    idx = dx<0 ? (idx+1)%modalImages.length :
                 (idx-1+modalImages.length)%modalImages.length;
    resetTransform();
    updateImg();
  }
});

/* ===== DOUBLE TAP ZOOM ===== */
let lastTap=0;
$('imgModal').addEventListener('click',()=>{
  const now = Date.now();
  if(now-lastTap<300){
    scale = scale>1 ? 1 : 2;
    dx=dy=0;
    applyTransform();
  }
  lastTap=now;
});

/* ===== UTILS ===== */
function getDist(t){
  return Math.hypot(
    t[0].clientX - t[1].clientX,
    t[0].clientY - t[1].clientY
  );
}
</script>

</body>
</html>
