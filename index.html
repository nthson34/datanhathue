<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra Cứu Thông Tin Tài Sản - Hệ Thống Hiện Đại</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Định nghĩa màu xanh dương chủ đạo */
            --primary-color: #1e40af; /* Blue 800 */
            --primary-light: #3b82f6; /* Blue 500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate 100 */
        }
        .header-bg {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 0;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .card {
            border-left: 5px solid var(--primary-color); /* Điểm nhấn màu xanh */
            transition: transform 0.2s, box-shadow 0.2s;
            border-radius: 0.5rem;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(30, 64, 175, 0.2), 0 4px 6px -2px rgba(30, 64, 175, 0.05);
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">

    <div class="header-bg sticky top-0 z-20">
        <div class="max-w-4xl mx-auto px-4 sm:px-6">
            <h1 class="text-3xl font-extrabold text-white text-center mb-1">
                Tra Cứu Thông Tin Tài Sản
            </h1>
            <p class="text-sm text-center text-blue-200 mb-4">Dữ liệu được truy xuất trực tiếp từ Google Sheet.</p>
            
            <div class="relative">
                <input 
                    type="text" 
                    id="searchInput" 
                    onkeyup="filterResults()"
                    placeholder="Đang tải dữ liệu..."
                    class="w-full p-3 pl-10 border border-gray-300 rounded-lg shadow-inner focus:ring-blue-400 focus:border-blue-400 text-gray-800 transition duration-150"
                    aria-label="Ô tìm kiếm thông tin"
                    disabled
                />
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
        </div>
    </div>
    
    <div class="max-w-4xl mx-auto p-4 sm:p-6 pb-12">

        <div id="statusMessage" class="bg-white rounded-lg shadow-lg text-center p-10 mt-6">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-lg text-gray-600">Đang kết nối đến Google Sheet...</p>
        </div>

        <div id="resultsContainer" class="grid hidden grid-cols-1 gap-6 mt-6">
            </div>

        <div id="noResults" class="hidden bg-yellow-50 border-l-4 border-yellow-500 text-yellow-700 p-4 mt-6">
            <p class="text-lg font-semibold">Không tìm thấy kết quả nào phù hợp.</p>
            <p class="text-sm">Vui lòng thử lại với từ khóa khác (Tên Chủ hoặc Địa Chỉ).</p>
        </div>
    </div>

    <script>
        // ==========================================================
        // KHU VỰC CẤU HÌNH GOOGLE SHEET (ĐÃ CẬP NHẬT)
        // ==========================================================
        const SHEET_ID = '14ntbPzHZdUEBAx7FxwEfpO0wBjyqaxNzXVYYphe_q2A'; 
        const SHEET_GID = '61368668'; 

        let allData = [];

        const resultsContainer = document.getElementById('resultsContainer');
        const noResultsMessage = document.getElementById('noResults');
        const searchInput = document.getElementById('searchInput');
        const statusMessage = document.getElementById('statusMessage');


        function getDirectDriveLink(link) {
            if (link && (link.includes('drive.google.com/file/d/') || link.includes('drive.google.com/open?id='))) {
                const match = link.match(/id=([a-zA-Z0-9_-]+)|d\/([a-zA-Z0-9_-]+)/);
                const fileId = match ? (match[1] || match[2]) : null;

                if (fileId) {
                    return `https://drive.google.com/uc?export=view&id=${fileId}`;
                }
            }
            return link;
        }

        // ==========================================================
        // HÀM KẾT NỐI VÀ LẤY DỮ LIỆU TỪ GOOGLE SHEET (ĐÃ SỬA LỖI TRUY VẤN HEADER)
        // ==========================================================
        async function fetchDataFromSheet() {
            // Thêm tham số 'headers=1' để API lấy tiêu đề từ hàng 1 và dữ liệu từ hàng 2
            const queryUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json;headers=1&gid=${SHEET_GID}`;

            try {
                const response = await fetch(queryUrl);
                const text = await response.text();
                
                const jsonText = text.substring(4, text.length - 2);
                const json = JSON.parse(jsonText);
                
                const rows = json.table.rows;
                
                // Cấu trúc cột dữ liệu, phải khớp với Tiêu đề HÀNG 1 trong Sheet của bạn
                const columnNames = [
                    "TÊN CHỦ", "Số điện thoại", "ĐỊA CHỈ", 
                    "LINK ẢNH", "GIÁ TIỀN", "TIỀN CỌC", "Hoa Hồng" 
                ];

                const processedData = rows.map(row => {
                    let item = {};
                    columnNames.forEach((colName, index) => {
                        item[colName] = row.c[index] && row.c[index].v !== null ? String(row.c[index].v) : '';
                    });
                    return item;
                }).filter(item => item["TÊN CHỦ"].trim() !== '');

                return processedData;

            } catch (error) {
                console.error("Lỗi khi tải dữ liệu từ Google Sheet:", error);
                statusMessage.innerHTML = `<p class="text-lg font-bold text-red-600">LỖI KẾT NỐI/DỮ LIỆU:</p><p class="text-sm text-red-500">Không thể tải dữ liệu. Vui lòng kiểm tra quyền truy cập công khai của Sheet.</p>`;
                return [];
            }
        }


        // Hàm tạo thẻ (card) HTML cho mỗi mục dữ liệu
        function createCard(item) {
            const imageUrl = getDirectDriveLink(item["LINK ẢNH"]);

            const card = document.createElement('div');
            card.className = 'card bg-white p-4 sm:p-6 rounded-xl shadow-md';
            
            card.innerHTML = `
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="w-full sm:w-1/3 flex-shrink-0">
                        <img 
                            src="${imageUrl}" 
                            alt="Ảnh tài sản của ${item["TÊN CHỦ"]}" 
                            class="w-full h-32 object-cover rounded-lg mb-3 sm:mb-0 shadow"
                            onerror="this.onerror=null;this.src='https://placehold.co/400x200/e0e7ff/3b82f6?text=KHONG+CO+ANH';"
                        >
                    </div>

                    <div class="w-full sm:w-2/3">
                        <h2 class="text-xl font-bold text-blue-800 truncate mb-1">${item["TÊN CHỦ"]}</h2>
                        
                        <p class="text-sm text-gray-700 mb-2 font-medium">
                            <span class="text-blue-600">Địa chỉ:</span> ${item["ĐỊA CHỈ"]}
                        </p>

                        <div class="grid grid-cols-3 gap-2 text-sm mb-3 border-t border-b py-2 border-gray-100">
                            <div>
                                <span class="block font-semibold text-green-700">Giá thuê:</span>
                                <span class="text-base font-extrabold text-red-600">${item["GIÁ TIỀN"]}</span>
                            </div>
                            <div>
                                <span class="block font-semibold text-gray-700">Cọc:</span>
                                <span class="text-base font-bold text-gray-900">${item["TIỀN CỌC"]}</span>
                            </div>
                            <div>
                                <span class="block font-semibold text-amber-700">Hoa Hồng:</span>
                                <span class="text-base font-bold text-amber-600">${item["Hoa Hồng"]}</span>
                            </div>
                        </div>

                        <div class="flex justify-start items-center">
                            <a href="tel:${item["Số điện thoại"]}" class="flex items-center text-sm bg-blue-100 text-blue-700 hover:bg-blue-200 px-3 py-1.5 rounded-full font-semibold transition">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74A1 1 0 0118 16.847V17a1 1 0 01-1 1h-1a1 1 0 01-1-1v-2.153a1 1 0 00-.836-.986l-4.435-.74a1 1 0 00-1.06.54l-.773 1.548a11.037 11.037 0 01-6.105-6.105l1.548-.774a1 1 0 00.54-1.059l-.74-4.435A1 1 0 013.153 3H3a1 1 0 01-1-1z"></path></svg>
                                Liên hệ: ${item["Số điện thoại"]}
                            </a>
                        </div>
                    </div>
                </div>
            `;
            return card;
        }

        // Hàm chính để lọc và hiển thị kết quả
        function filterResults() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            resultsContainer.innerHTML = '';
            noResultsMessage.classList.add('hidden');

            const dataToFilter = allData;

            const filteredData = dataToFilter.filter(item => {
                const owner = item["TÊN CHỦ"] ? item["TÊN CHỦ"].toLowerCase() : '';
                const address = item["ĐỊA CHỈ"] ? item["ĐỊA CHỈ"].toLowerCase() : '';
                
                return owner.includes(searchTerm) || address.includes(searchTerm);
            });

            if (filteredData.length > 0) {
                filteredData.forEach(item => {
                    resultsContainer.appendChild(createCard(item));
                });
                resultsContainer.classList.remove('hidden');
            } else {
                noResultsMessage.classList.remove('hidden');
                resultsContainer.classList.add('hidden');
            }
        }

        // Khởi tạo và tải dữ liệu
        window.onload = async function() {
            const data = await fetchDataFromSheet();
            allData = data;
            
            // Ẩn thông báo tải và hiện khung tìm kiếm/kết quả
            statusMessage.classList.add('hidden');
            searchInput.disabled = false;
            searchInput.placeholder = 'Nhập Tên Chủ hoặc Địa Chỉ để tra cứu...';

            if (allData.length > 0) {
                filterResults();
            } else {
                // Hiển thị lại thông báo nếu data rỗng nhưng không phải do lỗi kết nối
                if (!document.getElementById('statusMessage').innerHTML.includes('LỖI KẾT NỐI')) {
                     statusMessage.innerHTML = '<p class="text-lg text-gray-600">Sheet đã tải nhưng không có dữ liệu nào phù hợp để hiển thị.</p>';
                     statusMessage.classList.remove('hidden');
                }
            }
        };
    </script>
</body>
</html>
