<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra Cứu Thông Tin Tài Sản</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">

    <div class="max-w-4xl mx-auto p-4 sm:p-6 bg-white shadow-xl rounded-b-xl">
        <header class="mb-6 sticky top-0 bg-white pt-2 z-10">
            <h1 class="text-3xl font-bold text-gray-800 text-center mb-1">
                Tra Cứu Thông Tin Tài Sản
            </h1>
            <p class="text-sm text-center text-gray-500 mb-4">Tìm kiếm theo Tên Chủ hoặc Địa Chỉ.</p>

            <div class="relative">
                <input 
                    type="text" 
                    id="searchInput" 
                    onkeyup="filterResults()"
                    placeholder="Đang tải dữ liệu..."
                    class="w-full p-3 pl-10 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                    aria-label="Ô tìm kiếm thông tin"
                    disabled
                />
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
        </header>

        <div id="statusMessage" class="text-center py-10">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-lg text-gray-600">Đang kết nối đến Google Sheet...</p>
        </div>

        <div id="resultsContainer" class="grid hidden grid-cols-1 gap-6">
            </div>

        <div id="noResults" class="hidden text-center py-10 text-gray-500">
            <p class="text-lg">Không tìm thấy kết quả nào phù hợp.</p>
            <p class="text-sm">Vui lòng thử lại với từ khóa khác.</p>
        </div>
    </div>

    <script>
        // ==========================================================
        // KHU VỰC CẤU HÌNH GOOGLE SHEET
        // Đã cập nhật theo đường link bạn cung cấp:
        // https://docs.google.com/spreadsheets/d/14ntbPzHZdUEBAx7FxwEfpO0wBjyqaxNzXVYYphe_q2A/edit?pli=1#gid=61368668
        // ==========================================================
        const SHEET_ID = '14ntbPzHZdUEBAx7FxwEfpO0wBjyqaxNzXVYYphe_q2A'; 
        const SHEET_GID = '61368668'; 
        // LƯU Ý: Đảm bảo Sheet của bạn được đặt quyền "Bất kỳ ai có đường liên kết đều có thể xem"

        // Biến toàn cục để lưu trữ dữ liệu sau khi tải
        let allData = [];

        const resultsContainer = document.getElementById('resultsContainer');
        const noResultsMessage = document.getElementById('noResults');
        const searchInput = document.getElementById('searchInput');
        const statusMessage = document.getElementById('statusMessage');


        // Hàm chuyển đổi link Google Drive thành link hiển thị ảnh trực tiếp (export link)
        function getDirectDriveLink(link) {
            if (link && (link.includes('drive.google.com/file/d/') || link.includes('drive.google.com/open?id='))) {
                const match = link.match(/id=([a-zA-Z0-9_-]+)|d\/([a-zA-Z0-9_-]+)/);
                const fileId = match ? (match[1] || match[2]) : null;

                if (fileId) {
                    // Trả về link export trực tiếp
                    return `https://drive.google.com/uc?export=view&id=${fileId}`;
                }
            }
            return link;
        }

        // ==========================================================
        // HÀM KẾT NỐI VÀ LẤY DỮ LIỆU TỪ GOOGLE SHEET
        // Đã cập nhật URL query sử dụng biến SHEET_ID và SHEET_GID
        // ==========================================================
        async function fetchDataFromSheet() {
            // Sử dụng Google Visualization API Query Language để lấy dữ liệu
            const queryUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_GID}`;

            try {
                const response = await fetch(queryUrl);
                const text = await response.text();
                
                // Cắt chuỗi JSON (bỏ "/*O_o*/" và các ký tự bao quanh)
                const jsonText = text.substring(4, text.length - 2);
                const json = JSON.parse(jsonText);
                
                const rows = json.table.rows;
                
                // Cấu trúc cột dữ liệu (cần khớp với thứ tự các cột trong Sheet)
                const columnNames = [
                    "TÊN CHỦ", "SỐ ĐIỆN THOẠI", "ĐỊA CHỈ", 
                    "LINK ẢNH", "GIÁ TIỀN", "TIỀN CỌC", "HOA HỒNG"
                ];

                const processedData = rows.map(row => {
                    let item = {};
                    columnNames.forEach((colName, index) => {
                        // Lấy giá trị ô, nếu không tồn tại (cột trống) thì mặc định là chuỗi rỗng
                        item[colName] = row.c[index] && row.c[index].v !== null ? String(row.c[index].v) : '';
                    });
                    return item;
                }).filter(item => item["TÊN CHỦ"].trim() !== ''); // Loại bỏ các hàng trống (nếu cột A rỗng)

                return processedData;

            } catch (error) {
                console.error("Lỗi khi tải dữ liệu từ Google Sheet:", error);
                statusMessage.innerHTML = `<p class="text-lg font-bold text-red-600">LỖI KẾT NỐI/DỮ LIỆU:</p><p class="text-sm text-red-500">Không thể tải dữ liệu. Vui lòng kiểm tra ID Sheet, GID và đảm bảo quyền truy cập là công khai (Anyone with the link).</p>`;
                return [];
            }
        }


        // Hàm tạo thẻ (card) HTML cho mỗi mục dữ liệu
        function createCard(item) {
            // Chuyển đổi link ảnh trước khi sử dụng
            const imageUrl = getDirectDriveLink(item["LINK ẢNH"]);

            const card = document.createElement('div');
            card.className = 'card bg-white p-4 sm:p-6 rounded-xl border border-gray-200 shadow-md';
            
            // Xây dựng nội dung Card
            card.innerHTML = `
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="w-full sm:w-1/3 flex-shrink-0">
                        <img 
                            src="${imageUrl}" 
                            alt="Ảnh tài sản của ${item["TÊN CHỦ"]}" 
                            class="w-full h-32 object-cover rounded-lg mb-3 sm:mb-0"
                            onerror="this.onerror=null;this.src='https://placehold.co/400x200/cccccc/333333?text=Khong+co+anh';"
                        >
                    </div>

                    <div class="w-full sm:w-2/3">
                        <h2 class="text-xl font-bold text-blue-700 truncate">${item["TÊN CHỦ"]}</h2>
                        
                        <p class="text-sm text-gray-600 mb-2">
                            <span class="font-semibold text-gray-700">Địa chỉ:</span> ${item["ĐỊA CHỈ"]}
                        </p>

                        <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                            <div>
                                <span class="block font-medium text-green-600">Giá thuê:</span>
                                <span class="text-lg font-extrabold text-red-600">${item["GIÁ TIỀN"]}</span>
                            </div>
                            <div>
                                <span class="block font-medium text-gray-600">Cọc:</span>
                                <span class="text-lg font-bold">${item["TIỀN CỌC"]}</span>
                            </div>
                        </div>

                        <div class="flex justify-between items-center pt-2 border-t border-gray-100">
                            <a href="tel:${item["SỐ ĐIỆN THOẠI"]}" class="flex items-center text-sm text-purple-600 hover:text-purple-800 font-semibold transition">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74A1 1 0 0118 16.847V17a1 1 0 01-1 1h-1a1 1 0 01-1-1v-2.153a1 1 0 00-.836-.986l-4.435-.74a1 1 0 00-1.06.54l-.773 1.548a11.037 11.037 0 01-6.105-6.105l1.548-.774a1 1 0 00.54-1.059l-.74-4.435A1 1 0 013.153 3H3a1 1 0 01-1-1z"></path></svg>
                                Gọi ngay: ${item["SỐ ĐIỆN THOẠI"]}
                            </a>
                            <span class="text-xs font-medium text-amber-600 bg-amber-100 px-2 py-0.5 rounded-full">
                                HH: ${item["HOA HỒNG"]}
                            </span>
                        </div>
                    </div>
                </div>
            `;
            return card;
        }

        // Hàm chính để lọc và hiển thị kết quả
        function filterResults() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            resultsContainer.innerHTML = '';
            noResultsMessage.classList.add('hidden');

            const dataToFilter = allData;

            const filteredData = dataToFilter.filter(item => {
                // Đảm bảo các trường tồn tại trước khi gọi .toLowerCase()
                const owner = item["TÊN CHỦ"] ? item["TÊN CHỦ"].toLowerCase() : '';
                const address = item["ĐỊA CHỈ"] ? item["ĐỊA CHỈ"].toLowerCase() : '';
                
                // Lọc theo Tên Chủ hoặc Địa Chỉ
                return owner.includes(searchTerm) || address.includes(searchTerm);
            });

            if (filteredData.length > 0) {
                filteredData.forEach(item => {
                    resultsContainer.appendChild(createCard(item));
                });
                resultsContainer.classList.remove('hidden');
            } else {
                noResultsMessage.classList.remove('hidden');
                resultsContainer.classList.add('hidden');
            }
        }

        // Khởi tạo và tải dữ liệu
        window.onload = async function() {
            // Tải dữ liệu
            const data = await fetchDataFromSheet();
            allData = data;
            
            // Ẩn thông báo tải và hiện khung tìm kiếm/kết quả
            statusMessage.classList.add('hidden');
            searchInput.disabled = false;
            searchInput.placeholder = 'Nhập Tên Chủ hoặc Địa Chỉ để tra cứu...';

            // Lần đầu tải xong, hiển thị tất cả kết quả
            if (allData.length > 0) {
                filterResults();
            } else if (SHEET_ID) {
                // Nếu không có lỗi cấu hình nhưng data rỗng (Sheet có thể trống)
                statusMessage.innerHTML = '<p class="text-lg text-gray-600">Sheet đã tải nhưng không có dữ liệu để hiển thị.</p>';
                statusMessage.classList.remove('hidden');
            }
        };
    </script>
</body>
</html>
